<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
<title>Route Edit Proto</title>
<link rel="stylesheet" href="http://jsdev.arcgis.com/3.14/esri/css/esri.css">
<style>
html, body, #map {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
}
#results{
  bottom: 20px;
  left: 20px;
  width: 300px;
  height: 90px;
}

#cutBtn{
  background-color: white;
  color: black;
}

#title{
  top: 20px;
  width: 50%;
  height: 50px;;
  padding-top: 5px;
  text-align: center;
  margin: 0 0 0 25%;
}
.mainStyle{
  position: absolute;
  z-index: 99;
  background-color: white;
  color: darkblue;
  border-radius: 8px;
  border-width: medium;
  border-color: cornflowerblue;
  padding: 15px;
  opacity: 0.75;
}
</style>

<script>
var dojoConfig = {
  paths: {
    data: location.pathname.replace(/\/[^/]+$/, "") + "/data"
  }
};
</script>

<script src="http://jsdev.arcgis.com/3.14/"></script>
<script>
var map;
var routesFeatureLayer;
require(["esri/map",
         "esri/graphic",
         "esri/graphicsUtils",
         "esri/geometry/Extent",
         "esri/geometry/geometryEngine",
         "esri/geometry/Polyline",
         "esri/geometry/Point",
         "esri/SpatialReference",

         "esri/symbols/SimpleFillSymbol",
         "esri/symbols/SimpleLineSymbol",
         "esri/symbols/TextSymbol",
         "esri/symbols/Font",
         "esri/Color",
         "esri/renderers/SimpleRenderer",

         "esri/layers/FeatureLayer",
         "esri/layers/GraphicsLayer",
         "data/routes",

         "dojo/on",
         "dojo/_base/array",
         "dojo/dom",
         "dojo/domReady!"
], function(Map, Graphic, graphicsUtils, Extent, geometryEngine, Polyline, Point, SpatialReference, SimpleFillSymbol, SimpleLineSymbol, TextSymbol, Font, Color, SimpleRenderer, FeatureLayer, GraphicsLayer, routes, on, array, dom) {

  //xmin, ymin, xmax, ymax
  var initExtent = new Extent(-122.412636, 37.802260, -122.408795, 37.805083, new SpatialReference({wkid:4326}));

  //Instructions for using the app. Will update based on user behavior
  var drawInstructions = "Click outside the selected feature to begin drawing cutting line. Double-click to finish line and make final cut.";
  var initInstructions = "Select a feature by clicking on it.";
  var clickInstructions = "Choose editing operation below.";

  map = new Map("map", {
    basemap: "topo",
    extent: initExtent
  });

  //Layer symbology
  var routesym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("blue"), 3);
  var selectionSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("black"), 5);
  var cutterSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASH, new Color("red"), 2);

  var leftCutSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("green"), 5);
  var rightCutSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color('rgb(92, 54, 142)'), 5);
  var unCutSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color('rgb(198, 0, 196)'), 5);

  var renderer = new SimpleRenderer(routesym);

  //Get FeatureLayer created from FeatureCollection stored on the client through data/routes
  routesFeatureLayer = routes;
  routesFeatureLayer.setRenderer(renderer);
  map.addLayer(routesFeatureLayer);

  //Create graphics layer for labeling
  var displayLabels = new GraphicsLayer();
  var labelFont = new Font(14, Font.STYLE_NORMAL, Font.VARIANT_NORMAL, Font.WEIGHT_BOLD, "Verdana");
  var textSym = new TextSymbol("filler text", labelFont, new Color([128,0,0]));

  //Create selection layer to display selection symbol
  var selectionLayer = new GraphicsLayer();
  var originalGraphicSelection, selectedGraphic;

  //Create GraphicsLayer for cutting line
  var cutGraphic1, cutGraphic2, cutGraphic3;

  map.addLayer(selectionLayer);
  map.addLayer(displayLabels);

  //Define cutting line object
  var cutter = null;

  var isSelected = false;
  on(routesFeatureLayer, "click", selectFeature);
  //Select features on click event
  function selectFeature(evt){
    if (drawEnabled) {
      return;
    }

    selectionLayer.clear();

    originalGraphicSelection = evt.graphic;
    selectedGraphic = new Graphic(evt.graphic.geometry, selectionSym);

    selectionLayer.add(selectedGraphic);
    isSelected = true;

    evt.stopPropagation();  //stop click event from bubbling to map click handlers

    dom.byId("instructions").innerHTML = clickInstructions;

    return selectedGraphic;
  }

  //Manage map clicking for line drawing purposes
  var initClick;
  var clicks = 0;

  //cut button object
  var cutBtn = dom.byId("cutBtn");

  //Initialize drawing capabilities with click of cut button
  on(cutBtn, "click", function(){
    if (!isSelected) {
      alert("Please select a feature to cut first.");
      return;
    }

    dom.byId("instructions").innerHTML = drawInstructions;

    setBtn();

    clicks = 0;
    cutter = null;
    drawEnabled = true;
    map.disableMapNavigation();  //disable map navigation while drawing

    //After button is clicked watch for map click events
    on(map, "click", function(evt){
      clicks++;  //increment map clicking var for line construction purposes

      var initClickOutsideSelection = true;
      if (clicks === 1) {
        initClick = evt.mapPoint;  //set initial click to global var for testing purposes
        if (selectedGraphic) {
          initClickOutsideSelection = geometryEngine.disjoint(selectedGraphic.geometry, initClick);
        }
        if (!initClickOutsideSelection) {
          //Don't allow for cutting to being inside of selected feature
          alert("Start cutting line outside of selected feature.");
          dom.byId("instructions").innerHTML = clickInstructions;
          resetBtn();
        } else {
          //Create line and add to map
          var lineGeom = createPolyline(evt.mapPoint, evt.mapPoint);
          cutter = new Graphic(lineGeom, cutterSym);
          map.graphics.add(cutter);
        }
      }
      if(clicks > 1) {
        //Add additional line paths for each click (can be "buggy" at times) don't click too fast
        cutter.geometry.addPath([cutter.geometry.paths[cutter.geometry.paths.length-1][1], evt.mapPoint]);
        map.graphics.redraw();
      }

      //evt.stopPropagation();
    });
  });

  //When map is clicked outside of selected feature, clear selection
  on(map, "click", function(evt) {
    if (isSelected && !drawEnabled) {
      var isFeatureClicked = geometryEngine.intersects(originalGraphicSelection.geometry, evt.mapPoint);
      if (!isFeatureClicked) {
        clearSelectedFeatures();
        routesFeatureLayer.add(originalGraphicSelection);
      }
      else {
        return;
      }
    }
    else {
      return;
    }
 });

 //For managing cleared selections
 function clearSelectedFeatures(){
    selectionLayer.clear();
    isSelected = false;
    clicks = 0;
    cutter = null;
    selectedGraphic = null;
 }

  //After starting to draw a line, continue drawing with cursor movement
  on (map, "mouse-move", function(evt) {
    if (cutter && drawEnabled) {
      cutter.geometry.setPoint(cutter.geometry.paths.length-1, 1, evt.mapPoint);
      map.graphics.redraw();
      cutGeoms(selectedGraphic.geometry, cutter.geometry, evt.mapPoint, selectionLayer);
    } else {
      return;
    }
  });

 //Set button style to "activated" style
  function setBtn(){
    cutBtn.style.backgroundColor = "black";
    cutBtn.style.color = "white";
  }

 //Set button style to initial style
  function resetBtn(){
    cutBtn.style.backgroundColor = "white";
    cutBtn.style.color = "black";
  }

  var drawEnabled= false;

  //Finish drawing line on double-click event
  on(map, "dbl-click", function(evt){
    map.enableMapNavigation();

    drawEnabled = false;
    map.graphics.clear();
    var goodCut = cutGeoms(selectedGraphic.geometry, cutter.geometry, evt.mapPoint, routesFeatureLayer);
    if (goodCut) {
        //Add cut graphics to map and remove original selected graphic
        routesFeatureLayer.add(cutGraphic1);
        routesFeatureLayer.add(cutGraphic2);
        routesFeatureLayer.add(cutGraphic3);
        routesFeatureLayer.remove(originalGraphicSelection);

       cutIterations = 0;
       clearSelectedFeatures();

    } else {
      clearSelectedFeatures();
      drawEnabled = false;
    }
    resetBtn();
    dom.byId("instructions").innerHTML = initInstructions;

    var orchardGeoms = graphicsUtils.getGeometries(routesFeatureLayer.graphics);
    //labelAreas(orchardGeoms);
  });

  //cut the polygon with the line drawn on map
  var cutIterations = 0;
  function cutGeoms(poly, cutLine, endPoint, lyr){
    cutIterations++;
    routesFeatureLayer.disableMouseEvents();
    var crossTest = geometryEngine.crosses(cutLine, poly);
    var disjointTest = geometryEngine.disjoint(poly, endPoint);
    //Don't attempt cut if line doesn't properly cross selected geometry
    if(crossTest && disjointTest){
      var cutPolys = geometryEngine.cut(poly, cutLine);
      if(lyr === selectionLayer){
        lyr.clear();
        //Define final cut graphics and add temporary ones to map as mouse moves
        cutGraphic1 = new Graphic(cutPolys[0], leftCutSym);
        cutGraphic2 = new Graphic(cutPolys[1], rightCutSym);
        cutGraphic3 = new Graphic(cutPolys[2], unCutSym);

        lyr.add(new Graphic(cutPolys[0], leftCutSym));
        lyr.add(new Graphic(cutPolys[1], rightCutSym));
        lyr.add(new Graphic(cutPolys[2], unCutSym));
      }
      if(lyr === routesFeatureLayer){
        //For finishing the line
        selectionLayer.clear();
        routesFeatureLayer.enableMouseEvents();
      }
      return true;
    } else {
      routesFeatureLayer.enableMouseEvents();
      return false;
    }
  }

  function createPolyline(pt1, pt2){
    var pt1Cor = [pt1.x, pt1.y];
    var pt2Cor = [pt2.x, pt2.y];
    var lineJSON = {
        paths: [[pt1Cor, pt2Cor]],
        spatialReference: pt1.spatialReference
    };
    var polyline = new Polyline(lineJSON);
    return polyline;
  }

});
</script>
</head>

<body>
  <div id="map">
    <div class="mainStyle" id="results"><span id="instructions">Select a feature by clicking on it.</span><br><br>
    <button id="cutBtn">Cut Features</button><br><br>
<!--    <button id="mergeBtn">Merge Features</button>-->
  </div>
</div>
</body>
</html>
